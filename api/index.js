var z=Object.defineProperty;var W=(s,t,o)=>t in s?z(s,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[t]=o;var U=(s,t,o)=>W(s,typeof t!="symbol"?t+"":t,o);import L,{Router as M}from"express";import q from"cors";import m from"@distube/ytdl-core";import{YouTube as $}from"youtube-sr";import l from"path";import I,{rm as Q,unlink as K}from"fs";import V from"fluent-ffmpeg";import{path as X}from"@ffmpeg-installer/ffmpeg";import{v7 as G}from"uuid";import N from"cookie-parser";const J="tmp",Z=[{name:"__Secure-1PAPISID",value:"kjowoLUuKYH7xPbD/AMn1BDLx8pDbaKzEP",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:1},{name:"__Secure-1PSID",value:"g.a000rQgPzSH-5unDLlxKGswCMlThI0rKL2rNkw0doaUmdYSnyv5jjpqx4XEi3pD7yTHxIJLAogACgYKAX0SARASFQHGX2MiogwwEZ8dAmvE4CXn0qF1JBoVAUF8yKor4HwR7vyir2kg0VDh2_UF0076",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:2},{name:"__Secure-1PSIDCC",value:"AKEyXzWXnsxwy7w2qt0vNAg5ZBDAG-qPdLpCyomADjl0OBgVwykofWKrpU_H0Yyfv2WYz9iJ",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1765507243,storeId:"firefox-private",id:3},{name:"__Secure-1PSIDTS",value:"sidts-CjEB7wV3sZFmtx6hObAAqUVPPmmL4YymA_fWfebyebeszkvYo3g3Se2jI5p4RWE8RVmfEAA",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1765507229,storeId:"firefox-private",id:4},{name:"__Secure-3PAPISID",value:"kjowoLUuKYH7xPbD/AMn1BDLx8pDbaKzEP",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:5},{name:"__Secure-3PSID",value:"g.a000rQgPzSH-5unDLlxKGswCMlThI0rKL2rNkw0doaUmdYSnyv5jYOI3wDqcYmarZzLXP4jo_gACgYKAcASARASFQHGX2MiB3f0XDRo8TRHMWugo_VIoRoVAUF8yKrsrr9QD_c4FEB0_5i-cQED0076",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:6},{name:"__Secure-3PSIDCC",value:"AKEyXzWb8XzkK-Q7be4AfZc5rLsxYOvIcIxJC5gcOF0cp-3FaLqJrt_lDsX4O-ebytMPWl-eFg",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1765507243,storeId:"firefox-private",id:7},{name:"__Secure-3PSIDTS",value:"sidts-CjEB7wV3sZFmtx6hObAAqUVPPmmL4YymA_fWfebyebeszkvYo3g3Se2jI5p4RWE8RVmfEAA",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1765507229,storeId:"firefox-private",id:8},{name:"APISID",value:"MkVvRWnrV63TMaCr/AnNplhaGdruuVoqQj",domain:".youtube.com",hostOnly:!1,path:"/",secure:!1,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:9},{name:"HSID",value:"Am-pRW7ifTFB-gUvs",domain:".youtube.com",hostOnly:!1,path:"/",secure:!1,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:10},{name:"PREF",value:"f4=4000000&f6=40000000&tz=Africa.Cairo",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531241,storeId:"firefox-private",id:11},{name:"SAPISID",value:"kjowoLUuKYH7xPbD/AMn1BDLx8pDbaKzEP",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:12},{name:"SID",value:"g.a000rQgPzSH-5unDLlxKGswCMlThI0rKL2rNkw0doaUmdYSnyv5jPUzQZQ-_sUzMjDmELDLdugACgYKAc0SARASFQHGX2MiDW0tH5tguQ9Hsx-Pr35PQRoVAUF8yKq6d0iP2jb90Ynnz1pJF5KI0076",domain:".youtube.com",hostOnly:!1,path:"/",secure:!1,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:13},{name:"SIDCC",value:"AKEyXzUS7N8Nsjur95eHOf2ibbP37UXgqfPX6162T4f5R1mcshj6qwFkoYsYyAmX6ZpvzZEi",domain:".youtube.com",hostOnly:!1,path:"/",secure:!1,httpOnly:!1,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1765507243,storeId:"firefox-private",id:14},{name:"SSID",value:"AjhQBDxtY1bTn4RFq",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1768531229,storeId:"firefox-private",id:15},{name:"VISITOR_INFO1_LIVE",value:"0Zauf2ak77A",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1749523238,storeId:"firefox-private",id:16},{name:"VISITOR_PRIVACY_METADATA",value:"CgJFRxIEGgAgGg%3D%3D",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!1,firstPartyDomain:"",partitionKey:null,expirationDate:1749523238,storeId:"firefox-private",id:17},{name:"YSC",value:"rMV723-mdbc",domain:".youtube.com",hostOnly:!1,path:"/",secure:!0,httpOnly:!0,sameSite:"no_restriction",session:!0,firstPartyDomain:"",partitionKey:null,storeId:"firefox-private",id:18}],x=m.createAgent(Z),tt={origin:[/https:\/\/vidl-client.vercel.app/,/http:\/\/localhost:\d{4}/],credentials:!0,methods:["GET","POST"],optionsSuccessStatus:200};class A{constructor(t){U(this,"$sessionInfo",{sessionID:"",clientInfo:{state:"fetch",msg:"fetching info",progress:0},progressState:{duration:"",downloadProgressState:{total:0,finish:0},convertProgressState:{size:0,timeMark:""}}});typeof t=="string"?this.$sessionInfo.sessionID=t:this.$sessionInfo=t}set data(t){this.$sessionInfo=t}get data(){return this.$sessionInfo}set _clientInfo(t){this.$sessionInfo.clientInfo=t}get _clientInfo(){return this.$sessionInfo.clientInfo}set __duration(t){this.$sessionInfo.progressState.duration=t}get __duration(){return this.$sessionInfo.progressState.duration}set __downloadProgressState(t){this.$sessionInfo.progressState.downloadProgressState=t}get __downloadProgressState(){return this.$sessionInfo.progressState.downloadProgressState}set ___total(t){this.$sessionInfo.progressState.downloadProgressState.total=t}get ___total(){return this.$sessionInfo.progressState.downloadProgressState.total}set ___finish(t){this.$sessionInfo.progressState.downloadProgressState.finish=t}get ___finish(){return this.$sessionInfo.progressState.downloadProgressState.finish}set __convertProgressState(t){this.$sessionInfo.progressState.convertProgressState=t}get __convertProgressState(){return this.$sessionInfo.progressState.convertProgressState}}const C=s=>{const t=new Set;return m.filterFormats(s,o=>{var d,y,h,c;const n=(d=o==null?void 0:o.qualityLabel)==null?void 0:d.startsWith("4320p"),e=((y=o==null?void 0:o.qualityLabel)==null?void 0:y.startsWith("2160p"))||((h=o==null?void 0:o.qualityLabel)==null?void 0:h.startsWith("1440p")),r=o.hasVideo&&!o.hasAudio&&!URL.parse(o.url).hostname.includes("manifest")&&(n||e||!n&&!e),a=(c=o.qualityLabel)==null?void 0:c.split("p")[0],u=t.has(a);return r&&!u?(t.add(a),!0):!1})},j=s=>{const t=new Set;return m.filterFormats(s,o=>{const n=o.hasAudio&&!o.hasVideo,e=o.audioBitrate,r=t.has(e);return n&&!r?(t.add(e),!0):!1}).sort((o,n)=>n.audioBitrate-o.audioBitrate)},et=(s,t)=>{const o=new Map([[4320,{up:null,down:[2160,1440,1080,720,480,360,240,144]}],[2160,{up:[4320],down:[1440,1080,720,480,360,240,144]}],[1440,{up:[2160,4320],down:[1080,720,480,360,240,144]}],[1080,{up:[1440,2160,4320],down:[720,480,360,240,144]}],[720,{up:[1080,1440,2160,4320],down:[480,360,240,144]}],[480,{up:[720,1080,1440,2160,4320],down:[360,240,144]}],[360,{up:[480,720,1080,1440,2160,4320],down:[240,144]}],[240,{up:[360,480,720,1080,1440,2160,4320],down:[144]}],[144,{up:[240,360,480,720,1080,1440,2160,4320],down:null}]]);let n=0;if(n=s.findIndex(a=>a.qualityLabel.startsWith(`${t}p`)),n!==-1)return s[n];const e=o.get(t).up;if(e!==null){for(const a of e)if(n=s.findIndex(u=>u.qualityLabel.startsWith(`${a}`)),n!==-1)return s[n]}const r=o.get(t).down;if(r!==null){for(const a of r)if(n=s.findIndex(u=>u.qualityLabel.startsWith(`${a}`)),n!==-1)return s[n]}return null},ot=(s,t)=>{const o=new Map([[160,{up:null,down:[128,64,48]}],[128,{up:[160],down:[64,48]}],[64,{up:[128,160],down:[48]}],[48,{up:[64,128,160],down:null}]]);let n=0;if(n=s.findIndex(a=>a.audioBitrate===t),n!==-1)return s[n];const e=o.get(t).up;if(e!==null){for(const a of e)if(n=s.findIndex(u=>u.audioBitrate===a),n!==-1)return s[n]}const r=o.get(t).down;if(r!==null){for(const a of r)if(n=s.findIndex(u=>u.audioBitrate===a),n!==-1)return s[n]}return null},E=s=>{const[t,o,n]=s.split(":");return+t*60*60+ +o*60+ +n},st=(s,t)=>Math.floor(E(s)/E(t)*100),nt=s=>{const n=s/1048576,e=s%1048576/1024;return n>>>0?n.toFixed(2)+" gb":e>>>0?e.toFixed(2)+" mb":s+" kb"},rt=s=>{const t=l.resolve(g,s);try{if(I.existsSync(t))throw new Error(`[${t}] folder already exists`);I.mkdirSync(t,{recursive:!0})}catch{return{sessionFolderPath:t,error:!0}}return{sessionFolderPath:t,error:!1}},b=(s,t)=>{const o=l.resolve(g,s,"info.json");try{I.writeFileSync(o,JSON.stringify(t),{flag:"w",encoding:"utf-8"})}catch{return!1}return!0},B=s=>{try{const t=l.resolve(g,s,"info.json");return{success:!0,sessionInfo:JSON.parse(I.readFileSync(t,{encoding:"utf-8"}))}}catch{return{success:!1}}},D=(s,t,o)=>{const n=B(t);if(n.success){const e=new A(n.sessionInfo);switch(s){case"download":{e.___finish=e.___finish+1;const{total:r,finish:a}=e.__downloadProgressState;e._clientInfo={state:"progress",msg:`preparing...(${a}/${r})`,progress:Math.floor(a/r*100)};break}case"convert":{const{size:r,timeMark:a}=o;e.__convertProgressState={size:r,timeMark:a},e._clientInfo={state:"progress",msg:`converting...(${nt(r)})`,progress:st(a,e.__duration)};break}case"duration":{e.__duration=o.duration;break}}b(t,e.data)}},k=(s,t,o,n)=>new Promise(e=>{const r=I.createWriteStream(s);o.hasVideo;let a=!1;m.downloadFromInfo(t,{format:o,agent:x}).on("error",u=>{a=!0,r.end(),e({ok:!1})}).pipe(r).on("finish",()=>{a||(r.end(),D("download",n),e({ok:!0}))}).on("error",u=>{r.end(),e({ok:!1})}).on("close",()=>{})}),at=s=>{const t=new URL(s);return t.searchParams.delete("si"),t.href},i=!1,g=`/${J}`;V.setFfmpegPath(X);const it=async(s,t)=>{const{body:{searchUrl:o}}=s;let n=null;try{if(m.validateURL(o)){n=await m.getInfo(o,{agent:x});const e=n.formats,r=C(e),a=j(e);t.status(200).json({info:{videoFormats:r,audioFormats:a,videoDetails:n.videoDetails},type:"video"})}else if($.validate(at(o),"PLAYLIST")){const e=await $.getPlaylist(o,{fetchAll:!0,limit:1/0});t.status(200).json({info:{id:e.id,videoCount:e.videoCount,views:e.views,channel:e.channel,lastUpdate:e.lastUpdate,link:e.link,mix:e.mix,thumbnail:e.thumbnail,title:e.title,type:e.type,url:e.url,videos:e.videos,fake:e.fake},type:"list"})}else t.status(200).json({errMsg:"Invalid youtube url",type:"none"})}catch(e){console.log("🟩 VideoID:",n==null?void 0:n.videoDetails.videoId),t.status(200).json({errMsg:e.message,type:"none"})}},ut=async(s,t)=>{const o=G(),n=new A(o),{error:e}=rt(o);if(e)t.sendStatus(206);else{if(!b(o,n.data)){t.sendStatus(206);return}t.status(200).json({sessionID:o,progressInfo:n._clientInfo})}},lt=async(s,t)=>{const{body:{sessionID:o}}=s,n=l.resolve(g,o,"info.json");I.readFile(n,{encoding:"utf-8"},(e,r)=>{if(e)t.status(200).json({state:"error",msg:"session closed 💀",progress:0});else{const a=JSON.parse(r);t.status(200).json(a.clientInfo)}})},T=async(s,t,o)=>{const{body:{sessionID:n}}=s;t.on("finish",()=>{const e=l.resolve(g,n);Q(e,{recursive:!0,force:!0},r=>{})}),o()},Y=(s,t,o)=>{const{body:{searchUrl:n}}=s;try{if(!m.validateURL(n)){t.sendStatus(201);return}}catch{t.sendStatus(201);return}o()},H=(s,t,o)=>{const{body:{sessionID:n}}=s;try{const e=l.resolve(g,n);if(!I.existsSync(e)){t.sendStatus(202);return}}catch{t.sendStatus(202);return}o()},dt=async(s,t)=>{const{body:{searchUrl:o,quality:n,sessionID:e}}=s;try{const r=await m.getInfo(o,{playerClients:["IOS"],agent:x}),a=r.formats,u=et(C(a),n);if(u===null)throw new Error("Video format doesn't exist");const d=j(a)[0];if(d===void 0)throw new Error("Audio format doesn't exist");const y=B(e);if(!y.success){t.sendStatus(203);return}const h=new A(y.sessionInfo);if(h.___total=2,!b(e,h.data)){t.sendStatus(204);return}const c=l.resolve(g,e),w=l.resolve(c,`video.${u.container}`),_=l.resolve(c,`audio.${d.container}`),[p,P]=await Promise.allSettled([k(w,r,u,e),k(_,r,d,e)]);if(!p.value.ok||!P.value.ok){t.sendStatus(205);return}const F=l.resolve(c,"output.mp4");V(w).format("mp4").audioBitrate(d.audioBitrate).mergeAdd(_).saveToFile(F).on("start",()=>{}).on("codecData",S=>{const O={duration:S.duration};D("duration",e,O)}).on("progress",({targetSize:S,timemark:O})=>{D("convert",e,{size:S,timeMark:O})}).on("end",()=>{K(w,S=>{}),K(_,S=>{}),t.status(200).download(F,S=>{if(S){t.sendStatus(205);return}})}).on("error",S=>{t.sendStatus(205)})}catch{t.sendStatus(205)}},ct=async(s,t)=>{const{body:{searchUrl:o,quality:n,sessionID:e}}=s;try{const r=await m.getInfo(o,{playerClients:["IOS"],agent:x}),a=r.formats,u=ot(j(a),n);if(u===null)throw new Error("Audio format doesn't exist");const d=B(e);if(!d.success){t.sendStatus(203);return}const y=new A(d.sessionInfo);if(y.___total=1,!b(e,y.data)){t.sendStatus(204);return}const h=l.resolve(g,e),c=l.resolve(h,`audio.${u.container}`);if(!(await k(c,r,u,e)).ok){t.sendStatus(205);return}const _=l.resolve(h,"output.mp3");V(c).format("mp3").audioBitrate(u.audioBitrate).saveToFile(_).on("start",()=>{}).on("codecData",p=>{const P={duration:p.duration};D("duration",e,P)}).on("progress",({targetSize:p,timemark:P})=>{D("convert",e,{size:p,timeMark:P})}).on("end",()=>{K(c,p=>{}),t.status(200).download(_,p=>{if(p){t.sendStatus(205);return}})}).on("error",p=>{t.sendStatus(205)})}catch{t.sendStatus(205)}},ft=async(s,t)=>{const{body:{listUrl:o}}=s;t.status(200).json({listUrl:o})},v=M();v.post("/smart-search",it);v.post("/progress-info",lt);v.post("/video-download",Y,H,T,dt);v.post("/audio-download",Y,H,T,ct);v.post("/list-download",ft);var pt=v;const R=M();R.get("/ods",ut);R.use("/youtube",pt);var mt=R;const f=L();f.use(L.json({limit:"10mb"}));f.use(L.urlencoded({extended:!1,limit:"10mb"}));f.use(N());f.use(q(tt));f.use("/api",mt);f.get("/",async(s,t)=>{t.status(200).json({msg:"Welcome to VIDL API"})});f.get("*",async(s,t)=>{t.sendStatus(404)});{const s=process.env.PORT??3e3;f.listen(s,()=>{console.log(`Server Running On Port ${s}`)})}const bt=f;var Ft=f;export{Ft as default,bt as viteNodeApp};
